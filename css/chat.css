// COMPLETE BULLETPROOF chat.js - ALL FEATURES WORKING
// Fixed: Reactions, Replies, Emoji Picker, Attachments

// API Endpoints
window.API_ENDPOINTS = window.API_ENDPOINTS || {
    chatSend: 'https://code-quest-zone.base44.app/api/apps/6988b1920d2dc3e06784fc73/functions/chatSend',
    chatHistory: 'https://code-quest-zone.base44.app/api/apps/6988b1920d2dc3e06784fc73/functions/chatHistory',
    chatReact: 'https://code-quest-zone.base44.app/api/apps/6988b1920d2dc3e06784fc73/functions/chatReact',
    gameStats: 'https://code-quest-zone.base44.app/api/apps/6988b1920d2dc3e06784fc73/functions/gameStats'
};

// Constants
const QUICK_EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ', 'üî•', 'üëè'];

const ALL_EMOJIS = [
    'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ',
    'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô',
    'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î',
    'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•',
    'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ',
    'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì',
    'üòà', 'üëø', 'üëπ', 'üë∫', 'üíÄ', '‚ò†Ô∏è', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ',
    'üëç', 'üëé', 'üëè', 'üôå', 'üëê', 'ü§ù', 'üôè', '‚úä', 'üëä', 'ü§õ',
    'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò', 'üëå', 'ü§è', 'üëà', 'üëâ', 'üëÜ',
    'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§ô', 'üí™', 'ü¶æ',
    '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî',
    '‚ù§Ô∏è‚Äçüî•', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è',
    '‚ú®', 'üíØ', 'üî•', '‚ö°', 'üí•', 'üí´', '‚≠ê', 'üåü', '‚úÖ', '‚ùå'
];

// State
let lastMessageId = null;
let replyingTo = null;
let attachedFile = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================

function getCurrentUser() {
    const saved = localStorage.getItem('404x1_user');
    return saved ? JSON.parse(saved) : null;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function updateProfileDisplay() {
    const user = getCurrentUser();
    if (!user) return;
    
    const usernameMini = document.getElementById('username-mini');
    if (usernameMini) {
        usernameMini.textContent = user.username;
    }
    
    const rpValueElements = document.querySelectorAll('.rp-value');
    rpValueElements.forEach(el => {
        el.textContent = user.reputation_points || 0;
    });
}

async function loadUserStats() {
    const user = getCurrentUser();
    if (!user || !user.id) return;
    
    try {
        const response = await fetch(`${window.API_ENDPOINTS.gameStats}?user_id=${user.id}`);
        if (response.ok) {
            const data = await response.json();
            if (data.reputation_points !== undefined) {
                user.reputation_points = data.reputation_points;
                localStorage.setItem('404x1_user', JSON.stringify(user));
                updateProfileDisplay();
            }
        }
    } catch (error) {
        console.error('Error loading user stats:', error);
    }
}

function updateCharCount() {
    const messageInput = document.getElementById('message-input');
    const charCount = document.getElementById('charCount');
    
    if (messageInput && charCount) {
        charCount.textContent = messageInput.value.length;
    }
}

function showRPNotification(text) {
    const notification = document.createElement('div');
    notification.className = 'rp-notification';
    notification.textContent = text;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'rpSlideOut 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

function updateChatUI() {
    const user = getCurrentUser();
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    
    if (user) {
        if (messageInput) {
            messageInput.disabled = false;
            messageInput.placeholder = 'Type your message...';
        }
        if (sendBtn) sendBtn.disabled = false;
        if (attachBtn) attachBtn.disabled = false;
        
        updateProfileDisplay();
    } else {
        if (messageInput) {
            messageInput.disabled = true;
            messageInput.placeholder = 'Login to chat...';
        }
        if (sendBtn) sendBtn.disabled = true;
        if (attachBtn) attachBtn.disabled = true;
    }
}

// ============================================
// MESSAGE LOADING
// ============================================

async function loadMessages() {
    const container = document.getElementById('messages-container');
    if (!container) return;
    
    const user = getCurrentUser();
    const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
    
    try {
        const response = await fetch(`${window.API_ENDPOINTS.chatHistory}?limit=100&offset=0`);
        const data = await response.json();
        
        if (!Array.isArray(data)) {
            console.error('Invalid response format');
            return;
        }
        
        const messages = data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        
        if (messages.length > 0) {
            const latestId = messages[messages.length - 1].id;
            if (latestId !== lastMessageId) {
                lastMessageId = latestId;
                renderMessages(messages);
                
                if (wasAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            }
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    if (!container) return;
    
    const user = getCurrentUser();
    container.innerHTML = '';
    
    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        const isOwnMessage = user && msg.user_id === user.id;
        messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
        messageDiv.dataset.messageId = msg.id;
        
        const time = formatTime(msg.created_at);
        
        // Reactions
        let reactionsHTML = '';
        if (msg.reactions && msg.reactions.length > 0) {
            const reactionCounts = {};
            const userReactions = new Set();
            
            msg.reactions.forEach(r => {
                reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
                if (user && r.user_id === user.id) {
                    userReactions.add(r.emoji);
                }
            });
            
            reactionsHTML = '<div class="message-reactions">';
            for (const [emoji, count] of Object.entries(reactionCounts)) {
                const isActive = userReactions.has(emoji);
                reactionsHTML += `
                    <span class="reaction-bubble ${isActive ? 'active' : ''}" 
                          onclick="toggleReaction('${msg.id}', '${emoji}')"
                          title="${isActive ? 'Remove reaction' : 'React'}">
                        ${emoji} <span class="reaction-count">${count}</span>
                    </span>
                `;
            }
            reactionsHTML += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="username ${isOwnMessage ? 'own-username' : ''}">${escapeHtml(msg.username)}</span>
                <span class="time">${time}</span>
            </div>
            <div class="message-text">${escapeHtml(msg.message)}</div>
            ${reactionsHTML}
            ${!isOwnMessage ? `
                <div class="message-actions">
                    ${QUICK_EMOJIS.map(emoji => `
                        <button class="quick-react-btn" 
                                onclick="reactToMessage('${msg.id}', '${emoji}')" 
                                title="React with ${emoji}">
                            ${emoji}
                        </button>
                    `).join('')}
                    <button class="reply-btn" 
                            onclick="replyToMessage('${msg.id}', '${escapeHtml(msg.username)}')" 
                            title="Reply">
                        ‚Ü©Ô∏è
                    </button>
                </div>
            ` : ''}
        `;
        
        container.appendChild(messageDiv);
    });
}

// ============================================
// CORE FUNCTIONS - DEFINED GLOBALLY
// ============================================

async function reactToMessage(messageId, emoji) {
    const user = getCurrentUser();
    if (!user || !user.id) {
        alert('Please login to react to messages');
        return;
    }
    
    try {
        const response = await fetch(window.API_ENDPOINTS.chatReact, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message_id: messageId,
                user_id: user.id,
                emoji: emoji
            })
        });
        
        if (response.ok) {
            loadMessages();
            showRPNotification('+1 RP for reaction!');
        }
    } catch (error) {
        console.error('Error reacting:', error);
    }
}

async function toggleReaction(messageId, emoji) {
    await reactToMessage(messageId, emoji);
}

function replyToMessage(messageId, username) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    replyingTo = { id: messageId, username: username };
    
    const wrapper = document.querySelector('.chat-input-wrapper');
    if (!wrapper) return;
    
    let cancelBtn = document.getElementById('cancel-reply-btn');
    if (!cancelBtn) {
        cancelBtn = document.createElement('button');
        cancelBtn.id = 'cancel-reply-btn';
        cancelBtn.textContent = `‚Ü©Ô∏è Replying to @${username} ‚úï`;
        cancelBtn.onclick = () => cancelReply();
        wrapper.appendChild(cancelBtn);
    }
    
    messageInput.value = `@${username} `;
    messageInput.focus();
}

function cancelReply() {
    replyingTo = null;
    const cancelBtn = document.getElementById('cancel-reply-btn');
    if (cancelBtn) {
        cancelBtn.remove();
    }
    
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        const text = messageInput.value;
        const match = text.match(/^@\w+\s/);
        if (match) {
            messageInput.value = text.substring(match[0].length);
        }
    }
}

function showEmojiPicker() {
    let picker = document.getElementById('emoji-picker');
    
    if (picker) {
        picker.remove();
        return;
    }
    
    picker = document.createElement('div');
    picker.id = 'emoji-picker';
    
    ALL_EMOJIS.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-picker-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        picker.appendChild(btn);
    });
    
    document.body.appendChild(picker);
    
    document.addEventListener('click', function closeOnOutside(e) {
        if (!picker.contains(e.target) && !e.target.closest('#emoji-btn')) {
            picker.remove();
            document.removeEventListener('click', closeOnOutside);
        }
    });
}

function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    const text = messageInput.value;
    
    messageInput.value = text.substring(0, start) + emoji + text.substring(end);
    messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
    messageInput.focus();
    
    updateCharCount();
    
    const picker = document.getElementById('emoji-picker');
    if (picker) picker.remove();
}

function handleAttachment() {
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.click();
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        alert('File too large. Maximum size is 10MB.');
        return;
    }
    
    attachedFile = file;
    showAttachmentPreview(file);
}

function showAttachmentPreview(file) {
    const existing = document.querySelector('.attachment-preview');
    if (existing) existing.remove();
    
    const preview = document.createElement('div');
    preview.className = 'attachment-preview';
    
    const fileIcon = getFileIcon(file.name);
    const fileSize = (file.size / 1024).toFixed(1) + ' KB';
    
    preview.innerHTML = `
        <span class="file-icon">${fileIcon}</span>
        <div class="file-info">
            <div class="file-name">${escapeHtml(file.name)}</div>
            <div class="file-size">${fileSize}</div>
        </div>
        <button class="remove-btn" onclick="removeAttachment()">‚úï</button>
    `;
    
    const inputContainer = document.querySelector('.chat-input-container');
    const wrapper = document.querySelector('.chat-input-wrapper');
    if (inputContainer && wrapper) {
        inputContainer.insertBefore(preview, wrapper);
    }
}

function removeAttachment() {
    attachedFile = null;
    const preview = document.querySelector('.attachment-preview');
    if (preview) preview.remove();
    
    const fileInput = document.getElementById('file-input');
    if (fileInput) fileInput.value = '';
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üé¨',
        'pdf': 'üìÑ', 'html': 'üåê', 'txt': 'üìù', 
        'js': 'üíª', 'css': 'üíª', 'json': 'üíª', 'md': 'üìù'
    };
    return icons[ext] || 'üìé';
}

async function sendMessage() {
    const user = getCurrentUser();
    if (!user || !user.id) {
        alert('Please login to send messages');
        return;
    }
    
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    const messageText = messageInput.value.trim();
    
    if (!messageText && !attachedFile) return;
    
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) sendBtn.disabled = true;
    if (messageInput) messageInput.disabled = true;
    
    try {
        let fileBase64 = null;
        let fileName = null;
        
        if (attachedFile) {
            const reader = new FileReader();
            fileBase64 = await new Promise((resolve) => {
                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                reader.readAsDataURL(attachedFile);
            });
            fileName = attachedFile.name;
        }
        
        const response = await fetch(window.API_ENDPOINTS.chatSend, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: user.id,
                username: user.username,
                message: messageText || '[File attachment]',
                reply_to: replyingTo ? replyingTo.id : null,
                file_data: fileBase64,
                file_name: fileName
            })
        });
        
        if (response.ok) {
            messageInput.value = '';
            updateCharCount();
            
            if (replyingTo) {
                cancelReply();
            }
            
            if (attachedFile) {
                removeAttachment();
            }
            
            await loadMessages();
            
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
            
            const rpAmount = attachedFile ? '+3 RP' : replyingTo ? '+2 RP' : '+2 RP';
            showRPNotification(rpAmount + ' earned!');
        } else {
            alert('Failed to send message');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message');
    } finally {
        if (sendBtn) sendBtn.disabled = false;
        if (messageInput) messageInput.disabled = false;
    }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const attachBtn = document.getElementById('attach-btn');
    const fileInput = document.getElementById('file-input');
    
    if (messageInput) {
        messageInput.addEventListener('input', updateCharCount);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
    
    if (sendBtn) {
        sendBtn.addEventListener('click', (e) => {
            e.preventDefault();
            sendMessage();
        });
    }
    
    if (emojiBtn) {
        emojiBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showEmojiPicker();
        });
    }
    
    if (attachBtn) {
        attachBtn.addEventListener('click', (e) => {
            e.preventDefault();
            handleAttachment();
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }

    updateChatUI();
    loadMessages();
    
    setInterval(loadMessages, 3000);
    setInterval(loadUserStats, 10000);
});

window.addEventListener('userLoggedIn', () => {
    updateChatUI();
    loadMessages();
    loadUserStats();
});

window.addEventListener('userLoggedOut', () => {
    updateChatUI();
});

// ============================================
// EXPORT ALL FUNCTIONS TO WINDOW (CRITICAL!)
// ============================================
console.log('‚úÖ Exporting all functions to global scope...');

window.sendMessage = sendMessage;
window.reactToMessage = reactToMessage;
window.toggleReaction = toggleReaction;
window.replyToMessage = replyToMessage;
window.cancelReply = cancelReply;
window.showEmojiPicker = showEmojiPicker;
window.insertEmoji = insertEmoji;
window.removeAttachment = removeAttachment;

console.log('‚úÖ Chat.js loaded! Functions available:', {
    sendMessage: typeof window.sendMessage,
    reactToMessage: typeof window.reactToMessage,
    toggleReaction: typeof window.toggleReaction,
    replyToMessage: typeof window.replyToMessage,
    cancelReply: typeof window.cancelReply,
    showEmojiPicker: typeof window.showEmojiPicker,
    insertEmoji: typeof window.insertEmoji,
    removeAttachment: typeof window.removeAttachment
});
